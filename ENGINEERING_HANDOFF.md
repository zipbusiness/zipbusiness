# Engineering Handoff: ZipBusiness API Data Collection & ACF Integration

## Overview
This document outlines the implementation plan for collecting restaurant data for 6 major cities and ensuring proper ACF field population for Master Critic integration.

## Phase 1: Initial Data Collection

### Cities to Collect
1. Austin, TX
2. New York, NY
3. Los Angeles, CA
4. Chicago, IL
5. Miami, FL
6. San Francisco, CA

### Running the Collection Script

```bash
# Navigate to the API directory
cd /Users/jeffsnewmacbook/Desktop/zipbusiness/zipbusiness-api

# Make the script executable
chmod +x collect_cities.sh

# Run the collection script
./collect_cities.sh
```

**Expected Results:**
- ~100-200 restaurants per city
- Total: ~600-1,200 restaurants
- Time: ~5-10 minutes per city
- Cost: ~$0.032 per restaurant (Google Places Search API)

### What Gets Collected in Phase 1
- Restaurant name
- Basic address
- Rating (Google/Yelp aggregate)
- Review count
- Price tier ($-$$$$)
- Cuisine type/category
- Google Place ID (for Phase 2)
- Yelp ID (for Phase 2)
- Basic operational status

## Phase 2: ACF Field Enrichment

### Implementation Requirements

#### 1. Create New Endpoint
Create `/api/v1/restaurants/{zpid}/enrich` endpoint that:

```python
@router.post("/restaurants/{zpid}/enrich")
async def enrich_restaurant_for_acf(
    zpid: str,
    db: Session = Depends(get_db),
    api_key: str = Depends(verify_api_key)
):
    """
    Enriches a restaurant with all data needed for WordPress ACF fields
    Only called when restaurant makes a Master Critic top 10 list
    """
    # Fetch additional data from Google Places Details API
    # Update restaurant record with enriched data
    # Return complete ACF-ready data
```

#### 2. Data to Fetch in Phase 2

**From Google Places Details API ($0.017/call):**
```python
google_fields = [
    'formatted_phone_number',
    'website',
    'geometry',  # lat/lng for map
    'opening_hours',  # full schedule
    'photos',  # up to 3 photos
    'url'  # Google Maps URL
]
```

**From Yelp Business Details (if needed):**
```python
yelp_fields = [
    'url',  # Menu URL often in Yelp
    'photos',  # Additional photos
    'hours'  # Backup hours data
]
```

#### 3. ACF Field Mapping

```python
def map_to_acf_fields(restaurant):
    """Maps enriched restaurant data to WordPress ACF fields"""
    return {
        # Basic Info (from Phase 1)
        'business_type': 'restaurant',
        'address': restaurant.address,
        'city': restaurant.city,
        'state': restaurant.state,
        'zip_code': restaurant.zip_code,
        
        # Enriched Data (from Phase 2)
        'phone_number': restaurant.phone,
        'website_url': restaurant.website,
        'google_maps_location': {
            'address': restaurant.full_address,
            'lat': restaurant.latitude,
            'lng': restaurant.longitude
        },
        'menu_online': restaurant.menu_url,
        'business_hours': format_hours(restaurant.hours),
        'business_photo': restaurant.primary_photo_url,
        
        # From existing data
        'google_place_id': restaurant.google_place_id,
        'google_rating': restaurant.google_rating,
        'google_review_count': restaurant.google_review_count,
        'price_tier': restaurant.price_range,
        
        # Generated by Master Critic AI
        'master_critic_summary': None,  # AI generates
        'signature_dish': None,  # AI generates
        'top_dishes': None,  # AI generates
        'pillar_scores': None,  # AI generates
        
        # Future enhancements (not needed now)
        'popular_times': None,
        'delivery_links': None,
        'review_keywords': None,
        'live_busyness_status': None
    }
```

#### 4. WordPress Integration Update

Modify `class-restaurant-intelligence-integration.php`:

```php
public function enrich_restaurant_for_acf($zpid) {
    $endpoint = $this->api_url . '/api/v1/restaurants/' . $zpid . '/enrich';
    
    $response = wp_remote_post($endpoint, array(
        'headers' => array(
            'X-API-Key' => $this->api_key,
            'Content-Type' => 'application/json'
        )
    ));
    
    if (is_wp_error($response)) {
        return false;
    }
    
    $data = json_decode(wp_remote_retrieve_body($response), true);
    return $this->map_to_acf_fields($data);
}
```

#### 5. Master Critic List Generation Flow

```php
// In class-ai-service-enhanced.php
public function generate_list($city, $state, $category) {
    // Step 1: Get basic restaurants from Phase 1 data
    $restaurants = $this->restaurant_intelligence->get_restaurants($city, $state);
    
    // Step 2: AI selects top 10
    $top_10 = $this->ai_select_top_restaurants($restaurants, $category);
    
    // Step 3: Enrich ONLY the top 10
    foreach ($top_10 as &$restaurant) {
        $enriched = $this->restaurant_intelligence->enrich_restaurant_for_acf($restaurant['zpid']);
        $restaurant = array_merge($restaurant, $enriched);
    }
    
    // Step 4: AI generates editorial content
    $final_list = $this->ai_generate_content($top_10);
    
    return $final_list;
}
```

## Implementation Timeline

### Day 1: Data Collection
1. Run collection script for all 6 cities
2. Monitor API usage and costs
3. Verify data in PostgreSQL database

### Day 2: API Enhancement
1. Implement `/enrich` endpoint
2. Add ACF field mapping
3. Test with sample restaurant

### Day 3: WordPress Integration
1. Update Restaurant Intelligence Integration class
2. Modify Master Critic generation flow
3. Test full workflow

## Cost Analysis

### Phase 1 Costs (One-time)
- 1,000 restaurants × $0.032 = $32
- Well within Google's $200/month free tier

### Phase 2 Costs (Per List)
- 10 restaurants × $0.017 = $0.17 per list
- 100 lists/month = $17/month

### Total Monthly Cost
- Initial collection: $32 (one-time)
- Ongoing enrichment: ~$17/month
- **Total: Under $50/month**

## Monitoring & Optimization

### API Usage Tracking
```python
# Add to data collector
def log_api_usage(api_name, endpoint, cost):
    """Track API usage for cost monitoring"""
    # Log to database or file
    # Alert if approaching limits
```

### Performance Metrics
- Collection success rate
- Enrichment success rate  
- API response times
- Cost per restaurant
- Cache hit rates

## Testing Checklist

- [ ] Collection script runs successfully
- [ ] Data appears in PostgreSQL
- [ ] Basic restaurant data is complete
- [ ] Enrichment endpoint works
- [ ] ACF fields are properly mapped
- [ ] Master Critic uses real data
- [ ] Business pages have all fields
- [ ] API costs stay within budget

## Support & Troubleshooting

### Common Issues

1. **API Rate Limits**
   - Implement exponential backoff
   - Add delays between requests

2. **Missing Data**
   - Log restaurants with incomplete data
   - Have fallback sources

3. **Cost Overruns**
   - Set hard limits in code
   - Alert before limits reached

### Contacts
- API Documentation: https://zipbusiness-api.onrender.com/docs
- Render Dashboard: https://dashboard.render.com
- Google Cloud Console: https://console.cloud.google.com

## Next Steps

After successful implementation:
1. Expand to more cities
2. Add more business types (hotels, bars)
3. Implement review sentiment analysis
4. Add competitor analysis features